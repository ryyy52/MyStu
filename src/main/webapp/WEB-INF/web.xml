<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  ================================================================
  Web应用配置文件说明
  ================================================================
  这是Java Web应用的部署描述符（Deployment Descriptor）
  负责配置Servlet、过滤器、监听器、错误页面等Web应用的核心组件
  
  本应用架构：
  - MVC模式：Model(Service+DAO) + View(JSP) + Controller(Servlet)
  - 数据库：MySQL，通过JDBC直接连接
  - 用户认证：记住我功能，通过Cookie和会话实现
  - 安全：CSRF令牌防护，输入验证
  
  配置内容：
  1. 所有Servlet映射（7个控制器）
  2. 错误页面处理（404、500、403、异常）
  3. 会话超时设置（30分钟）
  4. 过滤器链（身份验证+记住我）
  5. 应用监听器（数据库初始化）
  ================================================================
-->
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">
    
    <!-- ==================== 1. 用户管理控制器配置 ==================== -->
    <!-- 
      负责处理用户相关的请求：注册、登录、注销、个人信息修改等
      URL映射：/user/*
      支持的操作：
      - /user/login：用户登录
      - /user/register：用户注册
      - /user/logout：用户注出
      - /user/profile：用户个人信息
    -->
    <servlet>
        <servlet-name>UserController</servlet-name>
        <servlet-class>com.ecommerce.controller.UserController</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>UserController</servlet-name>
        <url-pattern>/user/*</url-pattern>
    </servlet-mapping>
    
    <!-- ==================== 2. 商品分类控制器配置 ==================== -->
    <!-- 
      负责处理分类相关的请求：分类列表、新增、修改、删除等
      URL映射：/category/*
      支持的操作：
      - /category/list：分类列表
      - /category/save：新增分类
      - /category/update：修改分类
      - /category/delete：删除分类
      - /category/tree：分类树（JSON格式）
    -->
    <servlet>
        <servlet-name>CategoryController</servlet-name>
        <servlet-class>com.ecommerce.controller.CategoryController</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>CategoryController</servlet-name>
        <url-pattern>/category/*</url-pattern>
    </servlet-mapping>
    
    <!-- ==================== 3. 商品控制器配置 ==================== -->
    <!-- 
      负责处理商品相关的请求：商品列表、详情、搜索、新增、修改、删除等
      URL映射：/product/*
      支持的操作：
      - /product/list：商品列表（支持分类筛选和分页）
      - /product/detail：商品详情
      - /product/search：商品搜索
      - /product/add：显示添加商品表单
      - /product/save：保存商品（支持文件上传）
      - /product/delete：删除商品
      
      multipart-config配置说明：
      - max-file-size：单个文件最大大小 5MB（5242880字节）
      - max-request-size：整个请求的最大大小 10MB（10485760字节）
      - file-size-threshold：超过这个大小的文件会写入临时文件，0表示所有文件
    -->
    <servlet>
        <servlet-name>ProductController</servlet-name>
        <servlet-class>com.ecommerce.controller.ProductController</servlet-class>
        <!-- 文件上传配置 -->
        <multipart-config>
            <!-- 单个文件最大大小：5MB -->
            <max-file-size>5242880</max-file-size>
            <!-- 整个请求的最大大小：10MB -->
            <max-request-size>10485760</max-request-size>
            <!-- 文件缓冲阈值：0表示所有文件都会被处理 -->
            <file-size-threshold>0</file-size-threshold>
        </multipart-config>
    </servlet>
    <servlet-mapping>
        <servlet-name>ProductController</servlet-name>
        <url-pattern>/product/*</url-pattern>
    </servlet-mapping>
    <!-- 为了处理/product/save的POST请求，添加额外映射 -->
    <servlet-mapping>
        <servlet-name>ProductController</servlet-name>
        <url-pattern>/product/save</url-pattern>
    </servlet-mapping>
    
    <!-- ==================== 4. 购物车控制器配置 ==================== -->
    <!-- 
      负责处理购物车相关的请求：查看、添加、修改、删除、清空等
      URL映射：/cart/*
      支持的操作：
      - /cart/view：查看购物车
      - /cart/add：添加商品到购物车
      - /cart/update：修改购物车商品数量
      - /cart/remove：删除购物车商品
      - /cart/clear：清空购物车
      - /cart/view.json：查看购物车（JSON API）
      - /cart/add.json：添加商品（JSON API）
      
      说明：支持两种购物车存储方式
      - 未登录用户：Session存储
      - 已登录用户：数据库存储
    -->
    <servlet>
        <servlet-name>CartController</servlet-name>
        <servlet-class>com.ecommerce.controller.CartController</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>CartController</servlet-name>
        <url-pattern>/cart/*</url-pattern>
    </servlet-mapping>
    
    <!-- ==================== 5. 订单控制器配置 ==================== -->
    <!-- 
      负责处理订单相关的请求：创建订单、订单列表、订单详情等
      URL映射：/order/*
      支持的操作：
      - /order/create：创建订单（从购物车）
      - /order/list：订单列表
      - /order/detail：订单详情
      
      说明：
      - 只有已登录用户才能操作订单
      - 订单创建时会清空用户的购物车
    -->
    <servlet>
        <servlet-name>OrderController</servlet-name>
        <servlet-class>com.ecommerce.controller.OrderController</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>OrderController</servlet-name>
        <url-pattern>/order/*</url-pattern>
    </servlet-mapping>
    
    <!-- ==================== 6. 验证码生成Servlet配置 ==================== -->
    <!-- 
      负责生成图形化验证码，防止自动化机器人攻击
      URL映射：/captcha
      说明：
      - 每次请求生成新的验证码
      - 验证码存储在Session中
      - 返回JPEG格式的图片
      - 禁用缓存，确保每次都生成新验证码
    -->
    <servlet>
        <servlet-name>CaptchaServlet</servlet-name>
        <servlet-class>com.ecommerce.controller.CaptchaServlet</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>CaptchaServlet</servlet-name>
        <url-pattern>/captcha</url-pattern>
    </servlet-mapping>
    
    <!-- ==================== 7. 错误处理控制器配置 ==================== -->
    <!-- 
      负责统一处理应用中的所有错误和异常
      URL映射：/error
      说明：
      - 捕获HTTP错误状态码（404、500、403等）
      - 捕获未捕获的异常
      - 显示友好的错误页面
      - 记录错误日志
    -->
    <servlet>
        <servlet-name>ErrorController</servlet-name>
        <servlet-class>com.ecommerce.controller.ErrorController</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>ErrorController</servlet-name>
        <url-pattern>/error</url-pattern>
    </servlet-mapping>
    
    <!-- ==================== 8. 错误页面映射配置 ==================== -->
    <!-- 
      当发生特定错误或异常时，自动转发到错误处理控制器
      支持的错误类型：
      - 404：资源不存在
      - 500：服务器内部错误
      - 403：禁止访问/权限错误
      - 其他未捕获的异常
    -->
    <!-- 处理404资源不存在错误 -->
    <error-page>
        <error-code>404</error-code>
        <location>/error</location>
    </error-page>
    <!-- 处理500服务器内部错误 -->
    <error-page>
        <error-code>500</error-code>
        <location>/error</location>
    </error-page>
    <!-- 处理403禁止访问错误 -->
    <error-page>
        <error-code>403</error-code>
        <location>/error</location>
    </error-page>
    <!-- 处理所有未捕获的异常 -->
    <error-page>
        <exception-type>java.lang.Exception</exception-type>
        <location>/error</location>
    </error-page>
    
    <!-- ==================== 9. 欢迎页面配置 ==================== -->
    <!-- 
      当用户访问应用根目录时，默认显示的页面
      这里配置为登录页面，保证用户首先进行身份认证
    -->
    <welcome-file-list>
        <welcome-file>login.jsp</welcome-file>
    </welcome-file-list>

    <!-- ==================== 10. 会话配置 ==================== -->
    <!-- 
      配置HTTP会话的超时时间
      30分钟无活动后，会话自动过期
      过期后用户需要重新登录
    -->
    <session-config>
        <!-- 会话超时时间：30分钟 -->
        <session-timeout>30</session-timeout>
    </session-config>

    <!-- ==================== 11. 过滤器配置 ==================== -->
    <!-- 
      身份验证和记住我功能过滤器
      
      职责：
      1. 检查用户会话是否有效
      2. 如果会话无效，尝试从Cookie恢复用户信息（记住我功能）
      3. 如果都无效，重定向到登录页面
      
      过滤链顺序：
      - 请求来临 → AuthFilter → 目标Servlet → 响应返回
      
      说明：
      - 应用于所有URL（/*）确保全局覆盖
      - 在所有Servlet之前执行
      - 拦截所有HTTP请求
    -->
    <filter>
        <filter-name>AuthFilter</filter-name>
        <filter-class>com.ecommerce.filter.AuthFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>AuthFilter</filter-name>
        <!-- 应用于所有URL，确保所有请求都经过身份验证检查 -->
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <!-- ==================== 12. 应用监听器配置 ==================== -->
    <!-- 
      应用启动时的监听器
      
      DatabaseInitListener职责：
      1. 应用启动时检查数据库连接
      2. 如果数据库表不存在，自动执行初始化脚本
      3. 创建必要的表结构和初始数据
      4. 确保应用可以正常启动
      
      说明：
      - 只在应用启动时执行一次
      - 如果数据库已初始化，不会重复执行
      - 错误信息会输出到服务器日志
    -->
    <listener>
        <listener-class>com.ecommerce.utils.DatabaseInitListener</listener-class>
    </listener>

</web-app>